name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install frontend dependencies
      run: npm install
      
    - name: Install backend dependencies
      run: cd backend && npm install
      
    - name: Free port 3001 for testing
      run: |
        sudo fuser -k 3001/tcp || true
        pkill -f "node.*server.js" || true
      
    - name: Run frontend linting
      run: npm run lint
      
    - name: Run frontend type check
      run: npx tsc --noEmit
      
    - name: Build frontend
      run: npm run build
      
    - name: Start backend server for testing
      run: |
        cd backend
        echo "Starting backend server..."
        npm start > server.log 2>&1 &
        echo $! > backend.pid
        echo "Backend server started with PID: $(cat backend.pid)"
        sleep 5
        echo "Server log (first 20 lines):"
        head -20 server.log || echo "No log output yet"
      env:
        NODE_ENV: test
        PORT: 3001
        
    - name: Wait for backend to be ready
      run: |
        echo "Waiting for backend server to be ready..."
        for i in {1..30}; do
          if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
            echo "✅ Backend is ready!"
            break
          fi
          echo "⏳ Waiting for backend... ($i/30)"
          sleep 2
        done
        
        # Final check
        if ! curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
          echo "❌ Backend failed to start after 60 seconds"
          echo "Checking if process is still running..."
          ps aux | grep "node.*server.js" || echo "No backend process found"
          echo "Server log:"
          cat backend/server.log || echo "No server log found"
          exit 1
        fi
        
    - name: Run backend tests
      run: cd backend && npm test
      env:
        NODE_ENV: test
        
    - name: Run integration tests
      run: |
        chmod +x test/test-local.sh
        cd test && ./test-local.sh
      env:
        NODE_ENV: test
        
    - name: Security audit (frontend)
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: Security audit (backend)
      run: cd backend && npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: Cleanup backend server
      if: always()
      run: |
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) 2>/dev/null || true
          rm -f backend.pid
        fi
        pkill -f "node.*server.js" || true

  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build frontend Docker image
      run: docker build -f Dockerfile.frontend -t todo-frontend:test .
      
    - name: Build backend Docker image
      run: docker build -f backend/Dockerfile -t todo-backend:test ./backend
      
    - name: Test frontend container
      run: |
        docker run -d --name frontend-test -p 3000:80 todo-frontend:test
        sleep 10
        curl -f http://localhost:3000
        docker stop frontend-test && docker rm frontend-test
        
    - name: Free port 3001 for Docker test
      run: |
        docker rm -f backend-test || true
        sudo fuser -k 3001/tcp || true
        
    - name: Test backend container
      run: |
        docker run -d --name backend-test -p 3001:3001 \
          -e NODE_ENV=test \
          -e SMTP_HOST=smtp.ethereal.email \
          -e SMTP_USER=test@example.com \
          -e SMTP_PASS=testpassword \
          -e TO_EMAIL=test@example.com \
          todo-backend:test
        sleep 15
        curl -f http://localhost:3001/api/health
        docker stop backend-test && docker rm backend-test